<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>3D Focus Timer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #canvas3d {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
    }

    .control-panel {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      z-index: 1;
    }

    .segment-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: center;
    }

    .segment-label {
      min-width: 60px;
      font-weight: bold;
    }

    .segment-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .unit-label {
      margin-left: 5px;
      color: #666;
    }

    .sound-select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    #startBtn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }

    .timer-display {
      text-align: center;
      margin-top: 20px;
    }

    #countdown {
      font-family: monospace;
      font-size: 2em;
    }

    .scene-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      z-index: 2;
    }
  </style>
</head>
<body>
  <canvas id="canvas3d"></canvas>
  <button class="scene-toggle" id="sceneToggle">üå≤ Forest</button>

  <div class="control-panel">
    <div class="input-group">
      <label>Total Time (minutes)</label>
      <input type="number" id="totalTime" class="segment-input" min="1" value="60">
    </div>

    <div class="input-group">
      <label>Number of Segments</label>
      <input type="number" id="segmentCount" class="segment-input" min="1" value="2">
    </div>

    <div id="segmentInputs"></div>

    <button id="startBtn">Start Focus Session</button>

    <div class="timer-display">
      <div id="currentPhase">Ready</div>
      <div id="countdown">00:00</div>
    </div>
  </div>

  <script>
    // Â§öËØ≠Ë®ÄÈÖçÁΩÆ
    const i18n = {
      'en': {
        segment: 'Segment',
        unit: 'min',
        phase: ['Phase', 'of']
      },
      'zh-TW': {
        segment: 'Á¨¨',
        unit: 'ÂàÜÈêò',
        phase: ['ÈöéÊÆµ', '/']
      }
    };

    // Ëé∑ÂèñÊµèËßàÂô®ËØ≠Ë®Ä
    const getLanguage = () => navigator.language.startsWith('zh') ? 'zh-TW' : 'en';
    const lang = getLanguage();

    // 3DÂú∫ÊôØÂàùÂßãÂåñ
    let scene, camera, renderer, currentScene = 'city';
    function initThreeScene() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas3d') });
      renderer.setSize(window.innerWidth, window.innerHeight);
      createScene(currentScene);
    }

    // Èü≥ÊïàÁÆ°ÁêÜÂô®
    const soundManager = {
      currentSound: null,
      sounds: {
        storm: new Howl({ src: ['sounds/storm01.mp3'], loop: true }),
        lightrain: new Howl({ src: ['sounds/lightrain01.mp3'], loop: true }),
        none: { play: () => {}, stop: () => {} }
      },
      play(type) {
        this.stop();
        if(this.sounds[type]) {
          this.currentSound = this.sounds[type];
          this.currentSound.play();
        }
      },
      stop() {
        if(this.currentSound && this.currentSound.stop) {
          this.currentSound.stop();
        }
      }
    };

    // ËÆ°Êó∂Âô®Ê†∏ÂøÉ
    class Timer {
      constructor() {
        this.phases = [];
        this.currentPhase = 0;
        this.remaining = 0;
        this.interval = null;
      }

      start(phases) {
        this.stop();
        this.phases = phases;
        if(this.phases.length === 0) return;

        this.currentPhase = 0;
        this.remaining = this.phases[0].duration;
        soundManager.play(this.phases[0].sound);
        this.updateDisplay();

        this.interval = setInterval(() => {
          this.remaining--;
          this.updateDisplay();
          
          if(this.remaining <= 0) {
            this.currentPhase++;
            if(this.currentPhase >= this.phases.length) {
              this.stop();
              alert('Session Complete!');
              return;
            }
            this.remaining = this.phases[this.currentPhase].duration;
            soundManager.play(this.phases[this.currentPhase].sound);
          }
        }, 1000);
      }

      stop() {
        clearInterval(this.interval);
        soundManager.stop();
      }

      updateDisplay() {
        const minutes = Math.floor(this.remaining / 60).toString().padStart(2, '0');
        const seconds = (this.remaining % 60).toString().padStart(2, '0');
        document.getElementById('countdown').textContent = `${minutes}:${seconds}`;
        
        const [phaseText, separator] = i18n[lang].phase;
        document.getElementById('currentPhase').textContent = 
          lang === 'zh-TW' ?
          `${phaseText} ${this.currentPhase + 1}${separator}${this.phases.length}` :
          `${phaseText} ${this.currentPhase + 1} ${separator} ${this.phases.length}`;
      }
    }

    // ÁîüÊàêÂàÜÊÆµËæìÂÖ•
    function generateSegments(count) {
      const container = document.getElementById('segmentInputs');
      container.innerHTML = '';
      
      for(let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'segment-row';

        // ÂàÜÊÆµÊ†áÁ≠æ
        const label = document.createElement('span');
        label.className = 'segment-label';
        label.textContent = lang === 'zh-TW' ? 
          `${i18n[lang].segment}${i+1}ÊÆµ` : 
          `${i18n[lang].segment} ${i+1}`;

        // Êó∂Èó¥ËæìÂÖ•
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'segment-input';
        input.min = 1;
        input.value = i % 2 === 0 ? 25 : 5;

        // Âçï‰ΩçÊ†áÁ≠æ
        const unit = document.createElement('span');
        unit.className = 'unit-label';
        unit.textContent = i18n[lang].unit;

        // Â£∞Èü≥ÈÄâÊã©
        const select = document.createElement('select');
        select.className = 'sound-select';
        ['storm', 'lightrain', 'none'].forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type === 'none' ? 
            (lang === 'zh-TW' ? 'ÈùúÈü≥' : 'Mute') : 
            type.charAt(0).toUpperCase() + type.slice(1);
          select.appendChild(option);
        });

        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(unit);
        div.appendChild(select);
        container.appendChild(div);
      }
    }

    // 3DÂú∫ÊôØÁÆ°ÁêÜ
    function createScene(type) {
      scene.clear();
      if(type === 'city') {
        // Ê∑ªÂä†ÂüéÂ∏ÇÂú∫ÊôØÂÖÉÁ¥†...
      } else {
        // Ê∑ªÂä†Ê£ÆÊûóÂú∫ÊôØÂÖÉÁ¥†...
      }
    }

    // ÂàùÂßãÂåñ
    const timer = new Timer();
    initThreeScene();

    document.getElementById('segmentCount').addEventListener('input', function() {
      generateSegments(Math.max(1, parseInt(this.value) || 2));
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      const totalSeconds = parseInt(document.getElementById('totalTime').value) * 60;
      const segments = Array.from(document.querySelectorAll('.segment-row')).map(row => ({
        duration: (parseInt(row.querySelector('input').value) || 1) * 60,
        sound: row.querySelector('select').value
      }));

      let accumulated = 0;
      const phases = [];
      while(accumulated < totalSeconds) {
        for(const seg of segments) {
          const remaining = totalSeconds - accumulated;
          if(remaining <= 0) break;
          
          const duration = Math.min(seg.duration, remaining);
          phases.push({ ...seg, duration });
          accumulated += duration;
        }
      }

      timer.start(phases);
    });

    document.getElementById('sceneToggle').addEventListener('click', () => {
      currentScene = currentScene === 'city' ? 'forest' : 'city';
      document.getElementById('sceneToggle').textContent = 
        currentScene === 'city' ? 'üå≤ Forest' : 'üåÉ City';
      createScene(currentScene);
    });

    // È¶ñÊ¨°ÁîüÊàê
    generateSegments(2);

    // Â§ÑÁêÜÈü≥È¢ëËá™Âä®Êí≠Êîæ
    document.body.addEventListener('click', () => {
      Howler.autoUnlock = true;
      Howler.usingWebAudio = true;
    }, { once: true });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Focus Timer with Local Sounds</title>
  <style>
    /* 保持原有CSS樣式不變 */
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }

    .control-panel {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 400px;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .segment-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .segment-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .sound-select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    #startBtn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }

    .timer-display {
      text-align: center;
      margin-top: 20px;
      font-size: 1.2em;
    }

    #countdown {
      font-family: monospace;
      font-size: 1.5em;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <div class="input-group">
      <label>Total Time (minutes)</label>
      <input type="number" id="totalTime" class="segment-input" min="1" value="60">
    </div>

    <div class="input-group">
      <label>Number of Segments</label>
      <input type="number" id="segmentCount" class="segment-input" min="1" value="2">
    </div>

    <div id="segmentInputs"></div>

    <button id="startBtn">Start Focus Session</button>

    <div class="timer-display">
      <div id="currentPhase">Ready</div>
      <div id="countdown">00:00</div>
    </div>
  </div>

  <!-- 本地音檔 -->
  <audio id="stormSound" src="sounds/storm01.mp3"></audio>
  <audio id="lightRainSound" src="sounds/lightrain01.mp3"></audio>

  <script>
    let currentTimer = null;
    let currentAudio = null;
    let phaseList = [];

    const soundOptions = [
      { id: 'none', label: 'No Sound' },
      { id: 'storm', label: 'Storm' },
      { id: 'lightrain', label: 'Light Rain' }
    ];

    // 修正核心邏輯：確保分段時間正確計算
    function calculatePhases() {
      const totalSeconds = parseInt(document.getElementById('totalTime').value) * 60;
      const segmentInputs = Array.from(document.querySelectorAll('.segment-input'));
      const soundSelects = Array.from(document.querySelectorAll('.sound-select'));
      
      const rawSegments = segmentInputs.map((input, index) => ({
        duration: (parseInt(input.value) || 1) * 60, // 確保分鐘轉秒數
        sound: soundSelects[index].value
      }));

      let accumulated = 0;
      const finalPhases = [];
      
      while(accumulated < totalSeconds) {
        for(const seg of rawSegments) {
          const remaining = totalSeconds - accumulated;
          if(remaining <= 0) break;
          
          const duration = Math.min(seg.duration, remaining);
          finalPhases.push({
            duration: duration,
            sound: seg.sound
          });
          accumulated += duration;
          
          // 即時退出檢查
          if(accumulated >= totalSeconds) break;
        }
      }

      return finalPhases;
    }

    function startTimer() {
      if (currentTimer) clearInterval(currentTimer);
      phaseList = calculatePhases();
      
      // 新增保護邏輯
      if(phaseList.length === 0) {
        alert('請設置有效的分段時間！');
        return;
      }

      let currentPhase = 0;
      let remaining = phaseList[0].duration; // 正確使用分段時間
      playSound(phaseList[0].sound);

      updateDisplay(currentPhase, remaining);

      currentTimer = setInterval(() => {
        remaining--;
        
        updateDisplay(currentPhase, remaining);

        if (remaining <= 0) {
          currentPhase++;
          if (currentPhase >= phaseList.length) {
            clearInterval(currentTimer);
            playSound('none');
            alert('Session Complete!');
            return;
          }
          remaining = phaseList[currentPhase].duration; // 正確切換下個分段
          playSound(phaseList[currentPhase].sound);
        }
      }, 1000);
    }

    function updateDisplay(phaseIndex, seconds) {
      const totalPhases = phaseList.length;
      const currentSound = soundOptions.find(o => o.id === phaseList[phaseIndex].sound).label;
      
      document.getElementById('currentPhase').textContent = 
        `分段 ${phaseIndex + 1}/${totalPhases} (${currentSound})`;
      
      document.getElementById('countdown').textContent = 
        `${Math.floor(seconds / 60).toString().padStart(2, '0')}:` +
        `${(seconds % 60).toString().padStart(2, '0')}`;
    }

    function generateSegments(count) {
      const container = document.getElementById('segmentInputs');
      container.innerHTML = '';
      
      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'segment-row';
        
        const timeInput = document.createElement('input');
        timeInput.type = 'number';
        timeInput.className = 'segment-input';
        timeInput.min = 1;
        timeInput.value = i % 2 === 0 ? 25 : 5;
        timeInput.placeholder = '分鐘';

        const soundSelect = document.createElement('select');
        soundSelect.className = 'sound-select';
        soundOptions.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.id;
          option.textContent = opt.label;
          soundSelect.appendChild(option);
        });

        div.appendChild(timeInput);
        div.appendChild(soundSelect);
        container.appendChild(div);
      }
    }

    function playSound(type) {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }

      const audioMap = {
        storm: document.getElementById('stormSound'),
        lightrain: document.getElementById('lightRainSound')
      };

      currentAudio = audioMap[type];
      if (currentAudio) {
        currentAudio.loop = true;
        currentAudio.play().catch(e => {
          document.body.style.cursor = 'pointer';
          document.body.onclick = () => {
            currentAudio.play();
            document.body.style.cursor = 'default';
          }
        });
      }
    }

    // 初始化
    document.getElementById('segmentCount').addEventListener('input', function() {
      generateSegments(Math.max(1, this.value));
    });

    document.getElementById('startBtn').addEventListener('click', startTimer);
    generateSegments(2);
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Focus Timer - Local Test Version</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    /* 基础样式重置 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* 控制面板样式 */
    .control-panel {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      margin: 2rem;
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .segment-row {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      align-items: center;
    }

    .segment-input,
    .sound-select {
      flex: 1;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }

    #startBtn {
      width: 100%;
      padding: 1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background 0.3s;
    }

    #startBtn:hover {
      background: #45a049;
    }

    .timer-display {
      text-align: center;
      margin-top: 2rem;
    }

    #currentPhase {
      font-size: 1.2rem;
      color: #333;
      margin-bottom: 0.5rem;
    }

    #countdown {
      font-family: monospace;
      font-size: 2.5rem;
      color: #222;
      font-weight: bold;
    }

    .debug-info {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 1rem;
      border-radius: 6px;
      font-family: monospace;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <!-- 控制面板 -->
  <div class="control-panel">
    <div class="input-group">
      <label for="totalTime">Total Time (minutes)</label>
      <input type="number" id="totalTime" class="segment-input" min="1" value="60">
    </div>

    <div class="input-group">
      <label for="segmentCount">Number of Segments</label>
      <input type="number" id="segmentCount" class="segment-input" min="1" value="2">
    </div>

    <div id="segmentInputs"></div>

    <button id="startBtn" class="start-button">Start Focus Session</button>

    <div class="timer-display">
      <div id="currentPhase">Ready</div>
      <div id="countdown">00:00</div>
    </div>
  </div>

  <!-- 调试信息 -->
  <div class="debug-info" id="debugConsole"></div>

  <script>
    // 调试系统
    const debug = {
      log: (...args) => {
        const consoleDiv = document.getElementById('debugConsole');
        consoleDiv.innerHTML += `<div>${args.join(' ')}</div>`;
        console.log(...args);
      },
      clear: () => {
        document.getElementById('debugConsole').innerHTML = '';
      }
    };

    // 初始化日志
    debug.log('System Initializing...');

    // 音频管理器
    class AudioManager {
      constructor() {
        debug.log('Initializing Audio Manager...');
        this.sounds = {
          storm: this.loadSound('storm01.mp3'),
          lightrain: this.loadSound('lightrain01.mp3'),
          none: { play: () => {}, stop: () => {} }
        };
      }

      loadSound(filename) {
        debug.log(`Loading sound: ${filename}`);
        return new Howl({
          src: [`sounds/${filename}`],
          html5: true,
          format: ['mp3'],
          loop: true,
          onloaderror: (id, err) => {
            debug.log(`Sound load error: ${filename}`, err);
          }
        });
      }

      play(type) {
        debug.log(`Playing sound: ${type}`);
        this.stop();
        if(this.sounds[type]) {
          this.sounds[type].play();
        }
      }

      stop() {
        Object.values(this.sounds).forEach(sound => {
          if(sound.stop) sound.stop();
        });
      }
    }

    // 计时器核心
    class FocusTimer {
      constructor(audioManager) {
        this.audio = audioManager;
        this.phases = [];
        this.currentPhase = 0;
        this.remaining = 0;
        this.interval = null;
      }

      start(phases) {
        debug.log('Starting timer...');
        this.stop();
        this.phases = phases;
        
        if(this.phases.length === 0) {
          debug.log('Error: Empty phase list');
          return;
        }

        this.currentPhase = 0;
        this.remaining = this.phases[0].duration;
        this.updateDisplay();
        this.audio.play(this.phases[0].sound);

        this.interval = setInterval(() => this.tick(), 1000);
      }

      tick() {
        this.remaining--;
        this.updateDisplay();

        if(this.remaining <= 0) {
          this.currentPhase++;
          if(this.currentPhase >= this.phases.length) {
            this.stop();
            debug.log('Timer completed');
            alert('Session Complete!');
            return;
          }
          
          this.remaining = this.phases[this.currentPhase].duration;
          this.audio.play(this.phases[this.currentPhase].sound);
        }
      }

      stop() {
        clearInterval(this.interval);
        this.audio.stop();
      }

      updateDisplay() {
        const minutes = Math.floor(this.remaining / 60).toString().padStart(2, '0');
        const seconds = (this.remaining % 60).toString().padStart(2, '0');
        document.getElementById('countdown').textContent = `${minutes}:${seconds}`;
        document.getElementById('currentPhase').textContent = 
          `Phase ${this.currentPhase + 1}/${this.phases.length}`;
      }
    }

    // 界面初始化
    const audioManager = new AudioManager();
    const timer = new FocusTimer(audioManager);

    // 动态生成分段输入
    function generateSegments(count) {
      debug.log(`Generating ${count} segments...`);
      const container = document.getElementById('segmentInputs');
      container.innerHTML = '';
      
      for(let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'segment-row';
        
        // 时间输入
        const timeInput = document.createElement('input');
        timeInput.type = 'number';
        timeInput.className = 'segment-input';
        timeInput.min = 1;
        timeInput.value = i % 2 === 0 ? 25 : 5;
        timeInput.placeholder = 'Minutes';

        // 声音选择
        const soundSelect = document.createElement('select');
        soundSelect.className = 'sound-select';
        ['storm', 'lightrain', 'none'].forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type === 'none' ? 'Mute' : 
            type.charAt(0).toUpperCase() + type.slice(1);
          soundSelect.appendChild(option);
        });

        div.appendChild(timeInput);
        div.appendChild(soundSelect);
        container.appendChild(div);
      }
    }

    // 事件绑定
    document.getElementById('segmentCount').addEventListener('input', function() {
      const value = Math.max(1, parseInt(this.value) || 2);
      this.value = value;
      generateSegments(value);
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      debug.clear();
      debug.log('Start button clicked');
      
      const totalMinutes = parseInt(document.getElementById('totalTime').value) || 60;
      debug.log(`Total time: ${totalMinutes} minutes`);

      const segments = Array.from(document.querySelectorAll('.segment-row')).map((row, index) => {
        const input = row.querySelector('.segment-input');
        const select = row.querySelector('.sound-select');
        return {
          duration: (parseInt(input.value) || 1) * 60,
          sound: select.value
        };
      });

      debug.log('Raw segments:', JSON.stringify(segments));

      const totalSeconds = totalMinutes * 60;
      let accumulated = 0;
      const phases = [];
      
      while(accumulated < totalSeconds) {
        for(const seg of segments) {
          const remaining = totalSeconds - accumulated;
          if(remaining <= 0) break;
          
          const duration = Math.min(seg.duration, remaining);
          phases.push({ ...seg, duration });
          accumulated += duration;
          
          if(accumulated >= totalSeconds) break;
        }
      }

      debug.log('Processed phases:', JSON.stringify(phases));
      timer.start(phases);
    });

    // 初始设置
    generateSegments(2);
    debug.log('Initialization complete');

    // 首次点击处理
    document.body.addEventListener('click', () => {
      debug.log('First user interaction');
      Howler.autoUnlock = true;
      Howler.usingWebAudio = true;
    }, { once: true });
  </script>
</body>
</html>

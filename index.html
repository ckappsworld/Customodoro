<!DOCTYPE html>
<html>
<head>
  <title>Focus Timer Debug Version</title>
  <style>
    /* 保持原有CSS樣式不變 */
  </style>
</head>
<body>
  <div class="control-panel">
    <!-- 保持原有HTML結構不變 -->
  </div>

  <!-- 本地音檔 -->
  <audio id="stormSound" src="sounds/storm01.mp3"></audio>
  <audio id="lightRainSound" src="sounds/lightrain01.mp3"></audio>

  <script>
    // 添加调试模式开关
    const DEBUG_MODE = true;
    function debugLog(...args) {
      if(DEBUG_MODE) console.log('[DEBUG]', ...args);
    }

    let currentTimer = null;
    let currentAudio = null;
    let phaseList = [];

    const soundOptions = [
      { id: 'none', label: 'No Sound' },
      { id: 'storm', label: 'Storm' },
      { id: 'lightrain', label: 'Light Rain' }
    ];

    function calculatePhases() {
      try {
        const totalTimeInput = document.getElementById('totalTime');
        const totalSeconds = parseInt(totalTimeInput.value) * 60;
        debugLog('Total seconds:', totalSeconds);

        if(isNaN(totalSeconds) || totalSeconds <= 0) {
          throw new Error('Invalid total time');
        }

        const segmentInputs = Array.from(document.querySelectorAll('.segment-input'));
        const soundSelects = Array.from(document.querySelectorAll('.sound-select'));
        
        debugLog('Found segments:', segmentInputs.length);

        const rawSegments = segmentInputs.map((input, index) => {
          const minutes = parseInt(input.value) || 1;
          return {
            duration: minutes * 60,
            sound: soundSelects[index].value
          };
        });

        debugLog('Raw segments:', rawSegments);

        let accumulated = 0;
        const finalPhases = [];
        
        while(accumulated < totalSeconds) {
          for(const seg of rawSegments) {
            const remaining = totalSeconds - accumulated;
            if(remaining <= 0) break;
            
            const duration = Math.min(seg.duration, remaining);
            finalPhases.push({
              duration: duration,
              sound: seg.sound
            });
            accumulated += duration;
            
            if(accumulated >= totalSeconds) break;
          }
        }

        debugLog('Final phases:', finalPhases);
        return finalPhases;

      } catch (error) {
        console.error('Error in calculatePhases:', error);
        alert('設定錯誤：請檢查輸入數值');
        return [];
      }
    }

    function startTimer() {
      debugLog('Start button clicked');
      try {
        if (currentTimer) {
          clearInterval(currentTimer);
          currentTimer = null;
        }

        phaseList = calculatePhases();
        debugLog('Phase list:', phaseList);

        if(phaseList.length === 0) {
          alert('請先設定有效的分段時間！');
          return;
        }

        let currentPhase = 0;
        let remaining = phaseList[0].duration;
        debugLog('Initial phase duration:', remaining);

        playSound(phaseList[0].sound);
        updateDisplay(currentPhase, remaining);

        currentTimer = setInterval(() => {
          remaining--;
          
          updateDisplay(currentPhase, remaining);

          if (remaining <= 0) {
            currentPhase++;
            if (currentPhase >= phaseList.length) {
              clearInterval(currentTimer);
              playSound('none');
              alert('時間到！');
              return;
            }
            remaining = phaseList[currentPhase].duration;
            debugLog('Switching to phase:', currentPhase, 'duration:', remaining);
            playSound(phaseList[currentPhase].sound);
          }
        }, 1000);

      } catch (error) {
        console.error('Error in startTimer:', error);
        alert('發生未知錯誤，請刷新頁面');
      }
    }

    // 保持其他函式不變...
    function updateDisplay() { /* ... */ }
    function generateSegments() { /* ... */ }
    function playSound() { /* ... */ }

    // 初始化
    document.getElementById('segmentCount').addEventListener('input', function() {
      generateSegments(Math.max(1, this.value));
    });

    // 明確檢查按鈕是否存在
    const startBtn = document.getElementById('startBtn');
    if(startBtn) {
      startBtn.addEventListener('click', startTimer);
      debugLog('Start button initialized');
    } else {
      console.error('Start button not found!');
    }

    generateSegments(2);
    debugLog('Initialization complete');
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart Focus Timer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    /* 保持原有CSS樣式不變 */
    body { margin: 0; font-family: Arial; background: #f0f0f0; }
    .control-panel {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 400px;
    }
    /* 其他樣式保持不變... */
  </style>
</head>
<body>
  <div class="control-panel">
    <!-- 保持原有HTML結構 -->
    <div class="input-group">
      <label>Total Time (minutes)</label>
      <input type="number" id="totalTime" class="segment-input" min="1" value="60">
    </div>
    <div class="input-group">
      <label>Number of Segments</label>
      <input type="number" id="segmentCount" class="segment-input" min="1" value="2">
    </div>
    <div id="segmentInputs"></div>
    <button id="startBtn">Start Focus Session</button>
    <div class="timer-display">
      <div id="currentPhase">Ready</div>
      <div id="countdown">00:00</div>
    </div>
  </div>

  <script>
    // 音頻配置 (需替換為實際音頻URL)
    const soundMap = {
      storm: new Howl({ src: ['sounds/storm.mp3'], loop: true }),
      rain: new Howl({ src: ['sounds/rain.mp3'], loop: true }),
      cafe: new Howl({ src: ['sounds/cafe.mp3'], loop: true })
    };

    class FocusTimer {
      constructor() {
        this.phases = [];
        this.currentPhase = 0;
        this.remaining = 0;
        this.interval = null;
      }

      start(phases) {
        this.stop();
        this.phases = phases;
        if(this.phases.length === 0) return;

        this.currentPhase = 0;
        this.remaining = this.phases[0].duration;
        this.playSound(this.phases[0].sound);
        this.updateDisplay();

        this.interval = setInterval(() => this.tick(), 1000);
      }

      tick() {
        this.remaining--;
        this.updateDisplay();

        if(this.remaining <= 0) {
          this.stopSound();
          this.currentPhase++;
          
          if(this.currentPhase >= this.phases.length) {
            this.stop();
            alert('Session Complete!');
            return;
          }

          this.remaining = this.phases[this.currentPhase].duration;
          this.playSound(this.phases[this.currentPhase].sound);
        }
      }

      playSound(type) {
        this.stopSound();
        if(soundMap[type]) {
          soundMap[type].play();
        }
      }

      stopSound() {
        Object.values(soundMap).forEach(sound => sound.stop());
      }

      stop() {
        clearInterval(this.interval);
        this.stopSound();
      }

      updateDisplay() {
        const minutes = Math.floor(this.remaining / 60).toString().padStart(2, '0');
        const seconds = (this.remaining % 60).toString().padStart(2, '0');
        document.getElementById('countdown').textContent = `${minutes}:${seconds}`;
        document.getElementById('currentPhase').textContent = 
          `Phase ${this.currentPhase + 1}/${this.phases.length}`;
      }
    }

    // 初始化計時器
    const timer = new FocusTimer();

    // 分段生成邏輯
    function generateSegments(count) {
      const container = document.getElementById('segmentInputs');
      container.innerHTML = '';
      
      for(let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'segment-row';
        
        const timeInput = document.createElement('input');
        timeInput.type = 'number';
        timeInput.className = 'segment-input';
        timeInput.min = 1;
        timeInput.value = i % 2 === 0 ? 25 : 5;

        const soundSelect = document.createElement('select');
        soundSelect.className = 'sound-select';
        ['storm', 'rain', 'cafe'].forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type.toUpperCase();
          soundSelect.appendChild(option);
        });

        div.appendChild(timeInput);
        div.appendChild(soundSelect);
        container.appendChild(div);
      }
    }

    // 事件綁定
    document.getElementById('segmentCount').addEventListener('input', function() {
      generateSegments(Math.max(1, parseInt(this.value) || 2));
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      const totalMinutes = parseInt(document.getElementById('totalTime').value) || 60;
      const segments = Array.from(document.querySelectorAll('.segment-row')).map(row => ({
        duration: (parseInt(row.querySelector('.segment-input').value) || 1) * 60,
        sound: row.querySelector('.sound-select').value
      }));

      const totalSeconds = totalMinutes * 60;
      let accumulated = 0;
      const phases = [];
      
      while(accumulated < totalSeconds) {
        for(const seg of segments) {
          const remaining = totalSeconds - accumulated;
          if(remaining <= 0) break;
          
          const duration = Math.min(seg.duration, remaining);
          phases.push({ ...seg, duration });
          accumulated += duration;
          
          if(accumulated >= totalSeconds) break;
        }
      }

      timer.start(phases);
    });

    // 初始生成
    generateSegments(2);
  </script>
</body>
</html>

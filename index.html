<!DOCTYPE html>
<html>
<head>
  <title>Focus Timer with Sound</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }

    .control-panel {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 400px;
      z-index: 1000;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .segment-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .segment-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .sound-select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    #startBtn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }

    .timer-display {
      text-align: center;
      margin-top: 20px;
      font-size: 1.2em;
    }

    #countdown {
      font-family: monospace;
      font-size: 1.5em;
      margin-top: 10px;
    }

    .input-error {
      border: 2px solid #ff4444 !important;
      animation: shake 0.5s;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(5px); }
      50% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <div class="input-group">
      <label>Total Time (minutes)</label>
      <input type="number" id="totalTime" class="segment-input" min="1" value="60">
    </div>

    <div class="input-group">
      <label>Number of Segments</label>
      <input type="number" id="segmentCount" class="segment-input" min="1" value="2">
    </div>

    <div id="segmentInputs"></div>

    <button id="startBtn">Start Focus Session</button>

    <div class="timer-display">
      <div id="currentPhase">Ready</div>
      <div id="countdown">00:00</div>
    </div>
  </div>

  <!-- 本地音檔 (需自行建立 sounds 目錄並放入檔案) -->
  <audio id="stormSound" src="sounds/storm01.mp3"></audio>
  <audio id="lightRainSound" src="sounds/lightrain01.mp3"></audio>

  <script>
    let currentTimer = null;
    let currentAudio = null;
    let phaseList = [];

    const soundOptions = [
      { id: 'none', label: 'No Sound' },
      { id: 'storm', label: 'Storm' },
      { id: 'lightrain', label: 'Light Rain' }
    ];

    function calculatePhases() {
      try {
        const totalMinutes = parseInt(document.getElementById('totalTime').value);
        if (isNaN(totalMinutes)) throw new Error('Total time must be a number');
        if (totalMinutes <= 0) throw new Error('Total time must be greater than 0');

        const segmentInputs = Array.from(document.querySelectorAll('.segment-input'));
        const soundSelects = Array.from(document.querySelectorAll('.sound-select'));

        const rawSegments = segmentInputs.map((input, index) => {
          const minutes = parseInt(input.value);
          if (isNaN(minutes)) throw new Error(`Segment ${index + 1}: Invalid time`);
          if (minutes <= 0) throw new Error(`Segment ${index + 1}: Time must > 0`);
          
          return {
            duration: minutes * 60,
            sound: soundSelects[index].value
          };
        });

        let accumulated = 0;
        const totalSeconds = totalMinutes * 60;
        const finalPhases = [];
        
        while(accumulated < totalSeconds) {
          for(const seg of rawSegments) {
            const remaining = totalSeconds - accumulated;
            if(remaining <= 0) break;
            
            const duration = Math.min(seg.duration, remaining);
            finalPhases.push({
              duration: duration,
              sound: seg.sound
            });
            accumulated += duration;
            
            if(accumulated >= totalSeconds) break;
          }
        }

        return finalPhases;

      } catch (error) {
        alert(error.message);
        return [];
      }
    }

    function startTimer() {
      try {
        if (currentTimer) {
          clearInterval(currentTimer);
          currentTimer = null;
        }

        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        phaseList = calculatePhases();
        if(phaseList.length === 0) return;

        let currentPhase = 0;
        let remaining = phaseList[0].duration;
        playSound(phaseList[0].sound);
        updateDisplay(currentPhase, remaining);

        currentTimer = setInterval(() => {
          remaining--;
          
          updateDisplay(currentPhase, remaining);

          if (remaining <= 0) {
            currentPhase++;
            if (currentPhase >= phaseList.length) {
              clearInterval(currentTimer);
              playSound('none');
              alert('Session Complete!');
              return;
            }
            remaining = phaseList[currentPhase].duration;
            playSound(phaseList[currentPhase].sound);
          }
        }, 1000);

      } catch (error) {
        console.error('Error:', error);
      }
    }

    function updateDisplay(phaseIndex, seconds) {
      const totalPhases = phaseList.length;
      const currentSound = soundOptions.find(o => o.id === phaseList[phaseIndex].sound).label;
      
      document.getElementById('currentPhase').textContent = 
        `Phase ${phaseIndex + 1}/${totalPhases} (${currentSound})`;
      
      document.getElementById('countdown').textContent = 
        `${Math.floor(seconds / 60).toString().padStart(2, '0')}:` +
        `${(seconds % 60).toString().padStart(2, '0')}`;
    }

    function generateSegments(count) {
      const container = document.getElementById('segmentInputs');
      container.innerHTML = '';
      
      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'segment-row';
        
        const timeInput = document.createElement('input');
        timeInput.type = 'number';
        timeInput.className = 'segment-input';
        timeInput.min = 1;
        timeInput.value = i % 2 === 0 ? 25 : 5;
        timeInput.placeholder = 'Minutes';

        timeInput.addEventListener('input', function() {
          this.classList.toggle('input-error', isNaN(parseInt(this.value)));
        });

        const soundSelect = document.createElement('select');
        soundSelect.className = 'sound-select';
        soundOptions.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.id;
          option.textContent = opt.label;
          soundSelect.appendChild(option);
        });

        div.appendChild(timeInput);
        div.appendChild(soundSelect);
        container.appendChild(div);
      }
    }

    function playSound(type) {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }

      const audioMap = {
        storm: document.getElementById('stormSound'),
        lightrain: document.getElementById('lightRainSound')
      };

      currentAudio = audioMap[type];
      if (currentAudio) {
        currentAudio.loop = true;
        currentAudio.play().catch(e => {
          document.body.style.cursor = 'pointer';
          document.body.onclick = () => {
            currentAudio.play();
            document.body.style.cursor = 'default';
          }
        });
      }
    }

    // 初始化
    document.getElementById('segmentCount').addEventListener('input', function() {
      this.value = Math.max(1, parseInt(this.value) || 1);
      generateSegments(this.value);
    });

    document.getElementById('totalTime').addEventListener('input', function() {
      this.classList.toggle('input-error', isNaN(parseInt(this.value)));
    });

    document.getElementById('startBtn').addEventListener('click', startTimer);
    generateSegments(2);
  </script>
</body>
</html>

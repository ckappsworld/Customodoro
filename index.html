<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Focus Timer with Custom Sounds</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }

    .control-panel {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 400px;
      z-index: 1000;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .segment-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .segment-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .sound-select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    #startBtn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.3s;
    }

    #startBtn:hover {
      background: #45a049;
    }

    .timer-display {
      text-align: center;
      margin-top: 20px;
      font-size: 1.2em;
    }

    #countdown {
      font-family: monospace;
      font-size: 1.5em;
      margin-top: 10px;
    }

    .sound-test-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <div class="input-group">
      <label>Total Time (minutes)</label>
      <input type="number" id="totalTime" class="segment-input" min="1" value="60">
    </div>

    <div class="input-group">
      <label>Number of Segments</label>
      <input type="number" id="segmentCount" class="segment-input" min="1" value="2">
    </div>

    <div id="segmentInputs"></div>

    <button id="startBtn">Start Focus Session</button>

    <div class="timer-display">
      <div id="currentPhase">Ready</div>
      <div id="countdown">00:00</div>
    </div>
  </div>

  <script>
    // 音效管理器
    class SoundManager {
      constructor() {
        this.sounds = {
          storm: this.createSound('storm01.mp3'),
          lightrain: this.createSound('lightrain01.mp3')
        };
        this.currentSound = null;
      }

      createSound(filename) {
        return new Howl({
          src: [`sounds/${filename}`],
          html5: true, // 强制使用HTML5 Audio
          format: ['mp3'],
          onloaderror: (id, err) => {
            console.error('音效加载失败:', filename, err);
            alert(`音效加载失败: ${filename}`);
          }
        });
      }

      play(type) {
        this.stop();
        if(this.sounds[type]) {
          this.currentSound = this.sounds[type];
          this.currentSound.play();
        }
      }

      stop() {
        if(this.currentSound) {
          this.currentSound.stop();
        }
      }

      testSound(type) {
        if(this.sounds[type]) {
          this.sounds[type].play();
          setTimeout(() => this.sounds[type].stop(), 2000);
        }
      }
    }

    // 焦点计时器
    class FocusTimer {
      constructor(soundManager) {
        this.soundManager = soundManager;
        this.phases = [];
        this.currentPhase = 0;
        this.remaining = 0;
        this.interval = null;
      }

      start(phases) {
        this.stop();
        this.phases = phases;
        if(this.phases.length === 0) return;

        this.currentPhase = 0;
        this.remaining = this.phases[0].duration;
        this.updateDisplay();
        this.soundManager.play(this.phases[0].sound);

        this.interval = setInterval(() => this.tick(), 1000);
      }

      tick() {
        this.remaining--;
        this.updateDisplay();

        if(this.remaining <= 0) {
          this.currentPhase++;
          if(this.currentPhase >= this.phases.length) {
            this.stop();
            alert('时间到！');
            return;
          }
          this.remaining = this.phases[this.currentPhase].duration;
          this.soundManager.play(this.phases[this.currentPhase].sound);
        }
      }

      stop() {
        clearInterval(this.interval);
        this.soundManager.stop();
      }

      updateDisplay() {
        const minutes = Math.floor(this.remaining / 60).toString().padStart(2, '0');
        const seconds = (this.remaining % 60).toString().padStart(2, '0');
        document.getElementById('countdown').textContent = `${minutes}:${seconds}`;
        document.getElementById('currentPhase').textContent = 
          `阶段 ${this.currentPhase + 1}/${this.phases.length}`;
      }
    }

    // 界面初始化
    const soundManager = new SoundManager();
    const timer = new FocusTimer(soundManager);

    function generateSegments(count) {
      const container = document.getElementById('segmentInputs');
      container.innerHTML = '';
      
      for(let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'segment-row';
        
        // 时间输入
        const timeInput = document.createElement('input');
        timeInput.type = 'number';
        timeInput.className = 'segment-input';
        timeInput.min = 1;
        timeInput.value = i % 2 === 0 ? 25 : 5;
        timeInput.placeholder = 'Minutes';

        // 声音选择
        const soundSelect = document.createElement('select');
        soundSelect.className = 'sound-select';
        
        // 添加测试按钮
        const testBtn = document.createElement('button');
        testBtn.className = 'sound-test-btn';
        testBtn.textContent = 'Test';
        
        Object.entries(soundManager.sounds).forEach(([key]) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key.charAt(0).toUpperCase() + key.slice(1);
          soundSelect.appendChild(option);
        });

        // 绑定测试功能
        testBtn.onclick = () => {
          soundManager.testSound(soundSelect.value);
        };

        div.appendChild(timeInput);
        div.appendChild(soundSelect);
        div.appendChild(testBtn);
        container.appendChild(div);
      }
    }

    // 事件绑定
    document.getElementById('segmentCount').addEventListener('input', function() {
      generateSegments(Math.max(1, parseInt(this.value) || 2));
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      const totalMinutes = parseInt(document.getElementById('totalTime').value) || 60;
      const segments = Array.from(document.querySelectorAll('.segment-row')).map(row => ({
        duration: (parseInt(row.querySelector('.segment-input').value) || 1) * 60,
        sound: row.querySelector('.sound-select').value
      }));

      const totalSeconds = totalMinutes * 60;
      let accumulated = 0;
      const phases = [];
      
      while(accumulated < totalSeconds) {
        for(const seg of segments) {
          const remaining = totalSeconds - accumulated;
          if(remaining <= 0) break;
          
          const duration = Math.min(seg.duration, remaining);
          phases.push({ ...seg, duration });
          accumulated += duration;
          
          if(accumulated >= totalSeconds) break;
        }
      }

      timer.start(phases);
    });

    // 初始生成
    generateSegments(2);

    // 首次点击处理
    document.body.addEventListener('click', () => {
      Howler.autoUnlock = true;
      Howler.usingWebAudio = true;
    }, { once: true });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Focus Timer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      color: #333;
    }

    .control-panel {
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .segment-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: center;
      flex-wrap: wrap;
    }

    .segment-label {
      min-width: 60px;
      font-weight: bold;
    }

    .segment-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .unit-label {
      margin-left: 5px;
      color: #666;
    }

    .sound-select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .external-url {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: none;
    }

    #startBtn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
      font-weight: bold;
    }

    .timer-display {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    #countdown {
      font-family: monospace;
      font-size: 2.5em;
      margin: 10px 0;
    }

    #videoContainer {
      margin: 20px auto;
      width: 90%;
      max-width: 500px;
      height: 280px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      display: none;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <div class="input-group">
      <label>Total Time（Minutes）</label>
      <input type="number" id="totalTime" class="segment-input" min="1" value="60">
    </div>

    <div class="input-group">
      <label>Segments</label>
      <input type="number" id="segmentCount" class="segment-input" min="1" value="2">
    </div>

    <div id="segmentInputs"></div>

    <button id="startBtn">Start</button>

    <div class="timer-display">
      <div id="currentPhase">Ready</div>
      <div id="countdown">00:00</div>
    </div>
  </div>

  <div id="videoContainer"></div>

  <script>
    // 多語言配置
    const i18n = {
      'en': {
        segment: 'Segment',
        unit: 'min',
        phase: ['Phase', 'of'],
        enterUrl: 'Enter URL...'
      },
      'zh-TW': {
        segment: '第',
        unit: '分鐘',
        phase: ['階段', '/'],
        enterUrl: '輸入連結...'
      }
    };

    // 獲取瀏覽器語言
    const getLanguage = () => navigator.language.startsWith('zh') ? 'zh-TW' : 'en';
    const lang = getLanguage();

    // 媒體管理器
    const mediaManager = {
      currentMedia: null,
      currentType: null,
      videoContainer: document.getElementById('videoContainer'),
      playerCheckInterval: null,
      currentUrl: null,
      segmentDuration: 0,
      
      sounds: {
        birds: new Howl({ src: ['sounds/Birds01.mp3'], loop: true }),
        lightrain: new Howl({ src: ['sounds/lightrain01.mp3'], loop: true }),
        oceanwave: new Howl({ src: ['sounds/ocean-waves01.mp3'], loop: true }),
        storm: new Howl({ src: ['sounds/storm01.mp3'], loop: true }),
        waterstream: new Howl({ src: ['sounds/water-stream01.mp3'], loop: true }),
        waterflow: new Howl({ src: ['sounds/water-flow01.mp3'], loop: true }),
        wavealpha: new Howl({ src: ['sounds/waves-alpha01.mp3'], loop: true }),
        wavebeta: new Howl({ src: ['sounds/waves beta01.mp3'], loop: true }),
        none: { play: () => {}, stop: () => {} }
      },
      
      play(type, url, duration) {
        this.stop();
        this.currentType = type;
        this.currentUrl = url;
        this.segmentDuration = duration;
        
        if(type === 'youtube') {
          this.playYouTube(url);
        } else if(type === 'bilibili') {
          this.playBilibili(url);
        } else if(this.sounds[type]) {
          this.currentMedia = this.sounds[type];
          this.currentMedia.play();
        }
      },
      
      playYouTube(url) {
        let videoId = '';
        
        if(url.includes('youtube.com/watch')) {
          videoId = new URL(url).searchParams.get('v');
        } else if(url.includes('youtu.be/')) {
          videoId = url.split('youtu.be/')[1].split('?')[0];
        }
        
        if(videoId) {
          // 創建帶有API控制參數的嵌入URL
          const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&enablejsapi=1`;
          this.embedVideo(embedUrl, 'youtube');
        }
      },
      
      playBilibili(url) {
        let bvid = '';
        
        // 提取BV號碼，修正了提取方式
        if(url.includes('bilibili.com/video/')) {
          const match = url.match(/bilibili\.com\/video\/([^/?]+)/);
          if(match && match[1]) {
            bvid = match[1];
          }
        }
        
        if(bvid) {
          const embedUrl = `https://player.bilibili.com/player.html?bvid=${bvid}&autoplay=1&danmaku=0`;
          this.embedVideo(embedUrl, 'bilibili');
        }
      },
      
      embedVideo(embedUrl, videoType) {
        this.videoContainer.innerHTML = '';
        
        const iframe = document.createElement('iframe');
        iframe.src = embedUrl;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        iframe.id = `${videoType}-player`;
        
        this.videoContainer.appendChild(iframe);
        this.videoContainer.style.display = 'block';
        
        // 設置播放器檢查間隔
        this.setupPlayerMonitoring(videoType);
      },
      
      setupPlayerMonitoring(videoType) {
        // 清除已有的監控
        clearInterval(this.playerCheckInterval);
        
        if(videoType === 'youtube') {
          this.setupYouTubeMonitoring();
        } else if(videoType === 'bilibili') {
          this.setupBilibiliMonitoring();
        }
      },
      
      setupYouTubeMonitoring() {
        let player = null;
        let playerState = -1;
        
        // 加載YouTube API
        if(!window.YT) {
          const tag = document.createElement('script');
          tag.src = "https://www.youtube.com/iframe_api";
          const firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        
        // 定義onYouTubeIframeAPIReady回調
        window.onYouTubeIframeAPIReady = () => {
          // 檢查是否仍然是YouTube播放
          if(this.currentType !== 'youtube') return;
          
          const iframe = document.getElementById('youtube-player');
          if(!iframe) return;
          
          player = new YT.Player('youtube-player', {
            events: {
              'onStateChange': (event) => {
                playerState = event.data;
                // 如果視頻結束而階段還未結束，重新播放視頻
                if(playerState === YT.PlayerState.ENDED) {
                  player.playVideo();
                }
              }
            }
          });
        };
        
        // 如果API已加載，直接執行
        if(window.YT && window.YT.Player) {
          window.onYouTubeIframeAPIReady();
        }
      },
      
      setupBilibiliMonitoring() {
        // Bilibili不提供類似YouTube的API，但我們可以通過postMessage進行一些操控
        // 這裡僅實現基本監控，實際效果可能有限
        this.playerCheckInterval = setInterval(() => {
          const iframe = document.getElementById('bilibili-player');
          if(!iframe) {
            clearInterval(this.playerCheckInterval);
            return;
          }
          
          // 嘗試檢測播放狀態並在需要時重新加載
          try {
            iframe.contentWindow.postMessage('{"cmd":"isFullScreen"}', '*');
          } catch(e) {
            // 忽略跨域錯誤
          }
        }, 2000);
        
        // 監聽來自iframe的消息
        window.addEventListener('message', (event) => {
          if(event.data && typeof event.data === 'string') {
            try {
              const data = JSON.parse(event.data);
              // 如果檢測到視頻已經結束，重新加載iframe
              if(data.event === 'end') {
                this.reloadCurrentVideo();
              }
            } catch(e) {
              // 忽略解析錯誤
            }
          }
        });
      },
      
      reloadCurrentVideo() {
        if(this.currentType === 'youtube') {
          this.playYouTube(this.currentUrl);
        } else if(this.currentType === 'bilibili') {
          this.playBilibili(this.currentUrl);
        }
      },
      
      stop() {
        // 停止音頻
        if(this.currentMedia && this.currentMedia.stop) {
          this.currentMedia.stop();
        }
        
        // 清除監控間隔
        clearInterval(this.playerCheckInterval);
        
        // 隱藏視頻
        this.videoContainer.innerHTML = '';
        this.videoContainer.style.display = 'none';
        
        this.currentMedia = null;
        this.currentType = null;
        this.currentUrl = null;
      }
    };

    // 計時器核心
    class Timer {
      constructor() {
        this.phases = [];
        this.currentPhase = 0;
        this.remaining = 0;
        this.interval = null;
      }

      start(phases) {
        this.stop();
        this.phases = phases;
        if(this.phases.length === 0) return;

        this.currentPhase = 0;
        this.remaining = this.phases[0].duration;
        
        // 播放第一階段聲音
        mediaManager.play(this.phases[0].soundType, this.phases[0].soundUrl);
        this.updateDisplay();

        this.interval = setInterval(() => {
          this.remaining--;
          this.updateDisplay();
          
          if(this.remaining <= 0) {
            this.currentPhase++;
            if(this.currentPhase >= this.phases.length) {
              this.stop();
              alert('Done！');
              return;
            }
            this.remaining = this.phases[this.currentPhase].duration;
            mediaManager.play(this.phases[this.currentPhase].soundType, this.phases[this.currentPhase].soundUrl);
          }
        }, 1000);
      }

      stop() {
        clearInterval(this.interval);
        mediaManager.stop();
      }

      updateDisplay() {
        const minutes = Math.floor(this.remaining / 60).toString().padStart(2, '0');
        const seconds = (this.remaining % 60).toString().padStart(2, '0');
        document.getElementById('countdown').textContent = `${minutes}:${seconds}`;
        
        const [phaseText, separator] = i18n[lang].phase;
        document.getElementById('currentPhase').textContent = 
          lang === 'zh-TW' ?
          `${phaseText} ${this.currentPhase + 1}${separator}${this.phases.length}` :
          `${phaseText} ${this.currentPhase + 1} ${separator} ${this.phases.length}`;
      }
    }

    // 生成分段輸入
    function generateSegments(count) {
      const container = document.getElementById('segmentInputs');
      container.innerHTML = '';
      
      for(let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'segment-row';

        // 分段標籤
        const label = document.createElement('span');
        label.className = 'segment-label';
        label.textContent = lang === 'zh-TW' ? 
          `${i18n[lang].segment}${i+1}段` : 
          `${i18n[lang].segment} ${i+1}`;

        // 時間輸入
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'segment-input';
        input.min = 1;
        input.value = i % 2 === 0 ? 25 : 5;

        // 單位標籤
        const unit = document.createElement('span');
        unit.className = 'unit-label';
        unit.textContent = i18n[lang].unit;

        // 聲音選擇
        const select = document.createElement('select');
        select.className = 'sound-select';
        
        // 添加內建音效選項
        const builtInOptions = [
          {value: 'none', text: 'Mute'},
          {value: 'youtube', text: 'YouTube'},
          {value: 'bilibili', text: 'BiliBili'},
          {value: 'wavealpha', text: 'Alpha Waves'},
          {value: 'wavebeta', text: 'Beta Waves'},
          {value: 'birds', text: 'Birds'},
          {value: 'lightrain', text: 'Rain'},
          {value: 'oceanwave', text: 'Ocean Waves'},
          {value: 'storm', text: 'Storm'},
          {value: 'waterflow', text: 'Water Flow'},
          {value: 'waterstream', text: 'Water Stream'}
          
        ];
        
        builtInOptions.forEach(option => {
          const optElem = document.createElement('option');
          optElem.value = option.value;
          optElem.textContent = option.text;
          select.appendChild(optElem);
        });
        
        // 外部URL輸入框
        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.className = 'external-url';
        urlInput.placeholder = i18n[lang].enterUrl;
        urlInput.style.display = 'none';
        
        // 監聽選項變化以顯示/隱藏URL輸入框
        select.addEventListener('change', function() {
          urlInput.style.display = 
            (this.value === 'youtube' || this.value === 'bilibili') ? 'block' : 'none';
        });

        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(unit);
        div.appendChild(select);
        div.appendChild(urlInput);
        container.appendChild(div);
      }
    }

    // 初始化
    const timer = new Timer();

    document.getElementById('segmentCount').addEventListener('input', function() {
      generateSegments(Math.max(1, parseInt(this.value) || 2));
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      const totalSeconds = parseInt(document.getElementById('totalTime').value) * 60;
      const segments = Array.from(document.querySelectorAll('.segment-row')).map(row => ({
        duration: (parseInt(row.querySelector('input').value) || 1) * 60,
        soundType: row.querySelector('select').value,
        soundUrl: row.querySelector('.external-url').value
      }));

      let accumulated = 0;
      const phases = [];
      while(accumulated < totalSeconds) {
        for(const seg of segments) {
          const remaining = totalSeconds - accumulated;
          if(remaining <= 0) break;
          
          const duration = Math.min(seg.duration, remaining);
          phases.push({ ...seg, duration });
          accumulated += duration;
        }
      }

      timer.start(phases);
    });

    // 處理音頻自動播放
    document.body.addEventListener('click', () => {
      Howler.autoUnlock = true;
      Howler.usingWebAudio = true;
    }, { once: true });

    // 首次生成
    generateSegments(2);
  </script>
</body>
</html>
